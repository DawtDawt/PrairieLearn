<script>
    $(() => {
        $('#pl-artifact-scan-{{uuid}} [data-toggle="popover"]').popover({
            sanitize: false,
            container: 'body',
            template: '<div class="popover pl-artifact-scan-popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',
        });

    // NOTE: Dependency `js-crc` should be loaded in EJS parent view for client-side validation to work
    const barcode = $('#pl-artifact-barcode');
    const barcodeRequired = $('#pl-artifact-barcode-required');
    const showRequired = () => {
        $('#pl-artifact-barcode-required').css('display', 'inline-block');
    };
    const hideRequired = () => {
        $('#pl-artifact-barcode-required').css('display', 'none');
    };
    const showWarning = () => {
        $('#pl-artifact-barcode-invalid').css('display', 'inline-block');
    };
    const hideWarning = () => {
        $('#pl-artifact-barcode-invalid').css('display', 'none');
    };

    // listener
    barcode.keyup((e) => {
        const sanitized = barcode.val().toLowerCase().trim();
        const sha16 = sanitized.substring(sanitized.length-4, sanitized.length);
        const base32 = sanitized.replace(sha16, '');
        if (barcodeRequired && barcode.val().length == 0) {
            showRequired();
        } else {
            hideRequired();
        };
        if (barcode.val().length == 0 || crc16(base32) === sha16) {
            hideWarning();
            $(barcode).val(() => {
                return sanitized;
            });
        } else {
            showWarning();
        }
    });
});
</script>

{{#question}}
    <!-- Will likely want to add button to add more barcodes that increment up-->
    <div id="pl-artifact-scan-{{uuid}}" class="d-inline-block form-group">
        <label for="_pl_artifact_barcode">Barcode</label>
        <input type="text" id="pl-artifact-barcode" style="text-transform:uppercase" name="_pl_artifact_barcode">
        <span id="pl-artifact-barcode-invalid" class="badge text-danger badge-invalid" style="display: none;"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Invalid Barcode </span>
        {{#required}}
            <span id="pl-artifact-barcode-required" class="badge text-info badge-invalid"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Barcode Required </span>
        {{/required}}
    </div>
{{/question}}

{{^question}}
    <div id="pl-dropdown-{{uuid}}" class="d-inline-block">

        {{^parse-error}}
            <span class="badge badge-success"><i class="fa fa-check" aria-hidden="true"></i></span>
            <label for="_pl_artifact_barcode">Barcode</label>
            <input type="text" id="barcode" disabled name="_pl_artifact_barcode" value="{{barcode}}">
        {{/parse-error}}

        {{#parse-error}}
            <span class="badge text-danger badge-invalid"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Invalid Barcode </span>
            <input type="text" disabled value="{{barcode}}">
            <a href="javascript:void(0);" role="button" class="btn btn-sm btn-secondary small border" data-placement="auto" data-trigger="focus" data-toggle="popover" data-html="true" style="margin-left: 5px" title="Format Error" tabindex="0" data-content="{{parse-error}}"> Why <i class="fa fa-question-circle" aria-hidden="true"></i></a>
        {{/parse-error}}
    </div>
{{/question}}
