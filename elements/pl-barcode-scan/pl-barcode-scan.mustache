<script>
    $(() => {
        $('#pl-barcode-scan-{{uuid}} [data-toggle="popover"]').popover({
            sanitize: false,
            container: 'body',
            template: '<div class="popover pl-barcode-scan-popover" role="tooltip"><div class="arrow"></div><h3 class="popover-header"></h3><div class="popover-body"></div></div>',
        });
</script>
<script>
    $(() => {
        // NOTE: Dependency `js-crc` should be loaded in EJS parent view for client-side validation to work
        const barcode = $('#pl-artifact-barcode');
        const showBadge = (selector) => {
            $(selector).css('display', 'inline-block');
        };
        const hideBadge = (selector) => {
            $(selector).css('display', 'none');
        };
        const toggleInvalidBarcode = (barcode, base36, sha16) => {
            if (barcode.val().length == 0 || crc16(base36) === sha16) {
                hideBadge('#pl-artifact-barcode-invalid');
            } else {
                showBadge('#pl-artifact-barcode-invalid');
            }
        };
        const toggleBarcodeRequired = (barcode) => {
            const barcodeRequired = $('#pl-artifact-barcode-required');
            if (barcodeRequired && barcode.val().length == 0) {
                showBadge('#pl-artifact-barcode-required');
            } else {
                hideBadge('#pl-artifact-barcode-required');
            }
        };
        const toggleValidBarcode = (barcode, base36, sha16) => {
            if (crc16(base36) === sha16) {
                showBadge('#pl-artifact-barcode-valid');
            } else {
                hideBadge('#pl-artifact-barcode-valid');
            }
        };

        // listener
        barcode.keyup((e) => {
            const sanitized = barcode.val().toLowerCase().trim();
            const sha16 = sanitized.substring(sanitized.length-4, sanitized.length);
            const base36 = sanitized.replace(sha16, '');

            toggleBarcodeRequired(barcode);
            toggleInvalidBarcode(barcode, base36, sha16);
            toggleValidBarcode(barcode, base36, sha16);
        });
    });
</script>

{{#question}}
    <!-- Will likely want to add button to add more barcodes that increment up-->
    <div id="pl-barcode-scan-{{uuid}}" class="d-inline-block form-group">
        <label for="_pl_artifact_barcode">Barcode</label>
        <input type="text" id="pl-artifact-barcode" style="text-transform:uppercase" name="_pl_artifact_barcode">

        <div class="pl-artifact-barcode-badge-container d-inline-block">
            <span id="pl-artifact-barcode-invalid" class="badge text-danger" style="display: none;"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Invalid Barcode </span>
            <span id="pl-artifact-barcode-valid" class="badge text-success" style="display: none;"><i class="fa fa-check" aria-hidden="true"></i> Valid Barcode </span>
            {{#required}}
                <span id="pl-artifact-barcode-required" class="badge text-info"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Barcode Required </span>
            {{/required}}
        </div>
    </div>
{{/question}}

{{^question}}
    <div id="pl-dropdown-{{uuid}}" class="d-inline-block">

        {{^parse-error}}
            <span class="badge badge-success"><i class="fa fa-check" aria-hidden="true"></i></span>
            <input type="text" id="barcode" disabled name="_pl_artifact_barcode" value="{{barcode}}">
        {{/parse-error}}

        {{#parse-error}}
            <span class="badge text-danger badge-invalid"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> Invalid Barcode </span>
            <input type="text" disabled value="{{barcode}}">
            <a href="javascript:void(0);" role="button" class="btn btn-sm btn-secondary small border" data-placement="auto" data-trigger="focus" data-toggle="popover" data-html="true" style="margin-left: 5px" title="Format Error" tabindex="0" data-content="{{parse-error}}"> Why <i class="fa fa-question-circle" aria-hidden="true"></i></a>
        {{/parse-error}}
    </div>
{{/question}}
